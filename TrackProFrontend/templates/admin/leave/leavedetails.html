{% extends "index.html" %}
{% load static %} 
{% block headercontent %}
 Application Details
{% endblock %}
{% block content %}


<style>
  .maincarddiv{
      margin:8px;
  }
  .Activeleavecard{
      background:white;
      border:1px solid transparent;
      height: 250px;
      box-shadow: 0px 4px 8px #00000029;
      padding: 10px 0px;
      border-radius: 15px;


  }
  .Activebottomcard{
      background:white;
      border:1px solid transparent;
      height: 211px;
      box-shadow: 0px 4px 8px #00000029;
      border-radius: 15px;

  }

  .borderdiv{
      border: 1px solid lightgrey;
      border-radius: 10px;
      height: 150px;
      overflow-y: scroll;
  }
  .reastext{
      color:grey;
      font-size:14px;
      padding:4px;
      word-wrap: break-word;

  }
  .lheadlabel{
      font-size:14px;
      font-weight:500;
  }
  .parent {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: repeat(2, 1fr);
    padding: 2px 0 2px 16px;
    grid-row-gap: 15px;
  }
  .colcontainer{
      display:table;
      width:100%;
  }
  .coldiv{
      display: table-cell;
  }

  .div1 { grid-area: 1 / 1 / 2 / 2;padding: 15px 0 0 0; }
  .div2 { grid-area: 1 / 2 / 2 / 3;padding: 15px 0 0 0; }
  .div3 { grid-area: 2 / 1 / 3 / 2;padding: 15px 0 0 0; }
  .div4 { grid-area: 2 / 2 / 3 / 3;padding: 15px 0 0 0; }


  .activeleavedetails{
      font-size: 12px;
      color:grey;
      font-weight: 500;

  }
  .activeleavedetailscolored{
      color: var(--fc-main);
      font-weight: 500;
      font-size: 12px;

  }
  .imagediv{
      width:45px;
      height:45px;
      border-radius: 50%;
      margin:0px 6px;
  }
  .pasthistorycard{
      background:white;
      border:1px solid transparent;
      box-shadow: 0px 4px 8px #00000029;
      height:600px;
      border-radius:15px;
  }
  .select2-container .select2-selection--single .select2-selection__rendered {
          padding-top: 2px;
      }


      .cardheadding {
          font-size: 18px;
          font-weight: 500;
          padding: 8px;
          padding-bottom: 16px;


      }
      .innercardheading {
          font-size: 14px;
          color: grey;
      }
      .application_titles{
          font-size: 12px;
          color: grey;
      }
      .application_values{
          font-size: 14px;
          font-weight: 500;

      }
      .Application_div {
          border: 1px solid #dadada;
          height: 200px;
          margin: 12px;
          border-radius: 6px;
          background: #f9f9f9;

      }
      .Application_reason_div {
          border: 1px solid #dadada;
          height: 80px;
          margin: 12px;
          border-radius: 6px;
          color: grey;
          font-size: 14px;
          word-wrap: break-word;

      }
      .pastleaves{
          overflow-y: auto;
          height: 500px;

      }
      .myTrackProScore{
          cursor: pointer;
          margin: 0 10px;
          font-size: 16px;

      }
      .manager_heading{
          margin: 0 0 10px 0;
          font-size:14px;
      }
      .manager_reason {
        padding: 0px 0 0 35px;
        color: grey;
        font-size: 12px;
    }
      .modaltogglebtn {
          height: 24px;
          width: 24px;
      }
      .ApplicationWithdraw{
        color: #ff8000;
      }
      .ApplicationApproved{
        color: green;
      }
      .ApplicationRejected{
        color: red;
      }
      .ApplicationPending{
        color: orange;
      }
      @media only screen and (min-device-width : 768px) and (max-device-width : 1024px) { 
        .Activeleavecard{
          height: 450px;
          padding: 15px;
      
      }
      .scalable-div{
        margin: 10px 0px;
      }
          

    }
    .trackproBtn{
      cursor:pointer;
    }
    .designation-string{
      font-size:10px;
    }
    .name-string {
      font-size: 18px;
      font-weight: 500;
  }
</style>


<main class="main-wrapper">
  {% if messages %}
  <div class="row" style="justify-content: center;">
    <div class="col-sm-6 col-sm-offset-3">
      {% for message in messages %}
      <div style="display: flex; margin: 15px 0px;flex-direction: row-reverse;justify-content: center;align-items: center;" class="alert-meaasge alert alert-{{ message.tags }} alert-dismissible text-center" role="alert">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close" style="background: transparent; border: none; font-size: 25px; color: #ff0000;">
          <span aria-hidden="true">&times;</span>
        </button>
        <p style="margin-bottom: 0px;">{{ message }}</p>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
  <div id="snackbar"></div>
  
  <div class="maincarddiv">
    <div class="Activeleavecard">
        <div class="row">
            <div class="col-md-12">
                <div class="d-flex p-2 justify-content-between">
                    <span class="d-flex">
                        <div class="">
                            <img class="imagediv" width="40" height="40" src="{{application_details.Photo}}">
                        </div>
                        <div class="empinfodiv">
                            <div class="name-string">{{application_details.Name}}</div>
                            <div class="designation-string">{{application_details.Designation}}</div>
                        </div>
                    </span>

                    <span>
                        <span class="myTrackProScore">TrackPro Avg : {{TrackPro_average_percentage}} %
                            <span    data-bs-toggle="modal" data-bs-target="#TrackProPercentagehistory" aria-expanded="false" aria-controls="TrackProPercentagehistory"><img src="/static/Media/taskicons/toggle.svg" class="modaltogglebtn" alt="Paris"></span>
    
                        </span>
                    </span>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-4 col-md-6 scalable-div">
                    <div class="parent">
                        <div class="div1"> 
                            <div class="lheadlabel">Application ID</div>
                            <div class="activeleavedetails">{{application_details.ApplicationId}}</div>
                        </div>
                        <div class="div2">
                            <div class="lheadlabel">Type Of Application</div>
                            <div class="activeleavedetailscolored">{{application_details.Application_Type}}</div>
                        </div>
                        <div class="div3">
                            <div class="lheadlabel">{{application_details.total_days}} Days</div>
                            <div class="activeleavedetails">{{application_details.leavetype}}</div>
                         </div>
                        <div class="div4"> 
                            <div class="lheadlabel">Application Date</div>
                            <div class="activeleavedetailscolored   ">{{application_details.dates}} </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 scalable-div">
                    <div class="borderdiv p-2">
                        <div class="reastext">Reason - {{application_details.reason}}</div>
                        <div></div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 scalable-div">
                    <div class="borderdiv p-2 overflow-auto">
                        {% for manager in managers_status %}
                        
                        <div class="manager_heading"><img class="rounded-circle" width="25" height="25" src="{{manager.manager_photo}}"> {{manager.name}} {{manager.icon}}                         
                            {% if manager.comment %}
                                <div class="manager_reason">Reason - {{manager.comment}}</div>
                            {% endif %}
                        </div>


                        {% endfor %}
                    </div>
                </div>
                <div class="col-lg-2 col-md-6 scalable-div row">
                  {% for manager  in managers_status  %}
                    {% if manager.managerid == Login_Manager %}
                      {% if manager.Status == "Pending"%} 
                        {%if application_details.leave_status != "Withdraw" and application_details.leave_status != "Rejected" %}
                            <div class="col-lg-12 col-md-12">
                              <button  data-bs-toggle="modal" data-bs-target="#rejectmodal" class="btn w-75 my-2 btn-outline-danger btn-width btn-font rounded-pill">Reject</button>
                            </div>

                            <div class="col-lg-12 col-md-12">
                              <button  data-bs-toggle="modal" data-bs-target="#acceptmodal" class="btn w-75 my-2 btn-outline-success btn-width btn-font rounded-pill">Approve</button>
                            </div>
                        {%else%}

                          <div class="col-lg-12 col-md-12" ><span class="lheadlabel">Application Status</span> <br> <span class="application_values Application{{application_details.leave_status}}">{{application_details.leave_status}}</span></div>


                        {% endif %}

                      {%else%}


                          <div class="col-lg-12 col-md-12" ><span class="lheadlabel">Application Status</span> <br> <span class="application_values Application{{application_details.leave_status}}">{{application_details.leave_status}}</span></div>


                      {% endif %}
                    {% endif %}
                  {% endfor %}

                </div>
            </div>

        </div>
    </div>

    <div class="leavecard mt-4">
        <div class="row ">
            <div class="col-8 ">
                <div class="pasthistorycard">
                    <div class="d-flex p-2 justify-content-between">
                        <div class="cardheadding">Application History</div>
                        <div class="w-25">
                            <select class="js-example-basic-single" onchange="leavefilter()" id="typeofleave">
                                <option value="" selected>All</option>
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                                <option value="Withdraw">Withdraw</option>
                              </select>
                        </div>
                    </div>
                   
                    <div id="pastleaves" class="pastleaves overflow-auto">
                        {% for i in Past_Applications %}
                        <div class="Application_div overflow-auto"> 
                            <div class="px-3 pt-1 d-flex justify-content-between">
                                <div><span class="application_titles">Application ID</span> <br> <span class="application_values">{{i.ApplicationId }}</span></div>
                                <div><span class="application_titles">From</span><br> <span class="application_values">{{i.start_date}} </span></div>
                                <div><span class="application_titles">To</span><br> <span class="application_values">{{i.end_date}}</span></div>
                                <div><span class="application_titles">Application Type</span> <br> <span class="application_values">{{i.Application_Type}}</span></div>
                                <div><span class="application_titles">{{i.total_days}} Days</span> <br><span class="application_values"> {{i.leavetype}} </span></div>
                                <div><span class="application_titles">Status</span> <br> <span class="application_values Application{{i.leave_status }}">{{i.leave_status }}</span></div>
                              </div>
                            <div>
                                <div class="Application_reason_div custom-scrollable-div p-1 overflow-auto"> Reason -{{i.reason}}</div>
                            </div>
                            <div class="d-flex px-3 justify-content-between" id="managers_div{{i.id}}">
                                {% for j in i.managers_status  %}
                                    <p class="application_values">{{j.icon}} {{j.name}}</p>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="col-12 mb-4 Activebottomcard">
                    <div class="cardheadding">Application Overview</div>
                    <div class="d-flex justify-content-between px-2"><p class="innercardheading">Application Approved :</p> <p  class="innercardheading">{{approved_application_count}}/{{total_application_count}} </p></div>
                    <div class="d-flex justify-content-between px-2"><p class="innercardheading">Application Rejected :</p> <p  class="innercardheading">{{rejected_application_count}}/{{total_application_count}} </p></div>
                    <div class="d-flex justify-content-between px-2"><p class="innercardheading">Application Pending :</p> <p  class="innercardheading">{{pending_application_count}}/{{total_application_count}} </p></div>
                    <div class="d-flex justify-content-between px-2"><p class="innercardheading">Application Withdraw :</p> <p  class="innercardheading">{{withdraw_application_count}}/{{total_application_count}} </p></div>

                    
                    
                    


                </div>
                <div class="col-12 mb-4 Activebottomcard">
                    <div class="cardheadding">Application Approval %</div>
                    {% for manager in Application_Approval %}

                    <div class="d-flex justify-content-between px-2"><p class="innercardheading">{{manager.name}}</p> <p  class="innercardheading">{{manager.Avg_score}} %</p></div>


                    {% endfor %}

                </div>

        </div>
       

    </div>
  </div>


  <div class="modal fade" id="rejectmodal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg px-5">
    
      <div class="modal-content">           
        <div class="modal-header ps-4">
          <h5 class="modal-title py-2" id="exampleModalLabel">Reject Application</h5>
        </div>
        <div class="modal-body">
          
          
  
      
          <div class="row">
            <div class="col-12 px-4">
              <label for="reason">Comment </label>
              <textarea  rows="2" class="input-feild" rows="5" id="reason" name="comment" ></textarea>
                <span id="reasonerror" class="error-message"></span>
            </div>

          </div>
      
        
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-gradient-danger btn-rounded btn-fw" data-bs-dismiss="modal">Close</button>
          <span type="submit" class="btn btn-gradient-info btn-rounded btn-fw"  id="editEmployeeDetails" onclick="rejectleave()">Submit</span>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="acceptmodal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
    
      <div class="modal-content">           
        <div class="modal-header">
          <h5 class="modal-title py-2" id="exampleModalLabel">Accept Application</h5>
        </div>
        <div class="modal-body">
          <div class="row py-1">
            <div> Are you sure you want to Approve leave Request?
            </div>
          </div>            
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-gradient-danger btn-rounded btn-fw" data-bs-dismiss="modal">Close</button>
          <span  onclick="ApplicationApprove()" class="btn btn-gradient-info btn-rounded btn-fw" id="editEmployeeDetails">Approve</span>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="TrackProPercentagehistory" tabindex="-1" aria-labelledby="TrackProPercentagehistory" aria-hidden="true">
    <div class="modal-dialog  modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title py-2" >TrackPro Percentage History</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div id="" class="modal-body">

            <table class="table" style="width:100%;">
                <thead>
                  <tr class="tableHeadings">
                    <th>Sr No.</th>
                    <th>Year</th>
                    <th>Weeks</th>
                    <th>Percentage</th>
                  </tr>
                </thead>
                <tbody class="">
                    {% for i in TrackPro_Percentages_History %}
                    
                    <tr>
                    <td>{{forloop.counter}}</td>
                    <td>{{i.Year}}</td>
                    <td>{{i.Week}}</td>
                    <td>{{i.TrackProPercent}}</td>
                    </tr>
                    {% endfor %}
                </tbody>
              </table>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

</main>


{% endblock %}
{% block script %}
{{block.super}}
<script>


    function leavefilter(){
      
         
        var leave_status = $("#typeofleave").val();

        $.ajax( {
            url: frontendURL +"leave/past_leaves",
            type: 'POST',
            headers: {
              'Authorization':'Token {{token}}'
            },
            data:{
              csrfmiddlewaretoken:'{{ csrf_token }}',
              'leave_status':leave_status,
              'LeaveId':'{{application_details.id}}',
              'UserId':'{{application_details.UserId}}',
              },
            dataType: 'json',
            success: function(response){
                var html=''
                console.log("respo",response)
                $(response.Applications).each(function(a, b) {
                    html +=  
                    `
                    <div class="Application_div overflow-auto"> 
                        <div class="px-3 pt-1 d-flex justify-content-between">
                            <div><span class="application_titles">Application ID</span> <br> <span class="application_values">`+b.ApplicationId+` </span></div>
                            <div><span class="application_titles">From</span><br> <span class="application_values">`+b.start_date+` </span></div>
                            <div><span class="application_titles">To</span><br> <span class="application_values">`+b.end_date+`</span></div>
                            <div><span class="application_titles">Application Type</span> <br> <span class="application_values">`+b.Application_Type+`</span></div>
                            <div><span class="application_titles">`+b.total_days+` Days</span> <br><span class="application_values"> `+b.leavetype+` </span></div>
                            <div><span class="application_titles">Status</span> <br> <span class="application_values Application`+b.leave_status+`"> `+b.leave_status+`</span></div>

                        </div>
                        <div>
                            <div class="Application_reason_div custom-scrollable-div p-1 overflow-auto"> Reason -`+b.reason+`</div>
                        </div>
                        <div class="d-flex px-3 justify-content-between" id="managers_div`+b.id+`">
         
                        </div>
                    </div>

                    `


                })
                $('#pastleaves').html(html);
                $(response.Applications).each(function(a, b) {
                    pstatus="";
                    $(b.managers_status).each(function(x, y) {
        
                      
                        console.log("-----",y.icon,y.name)
        
        
        
                        pstatus+=
                        `
                        <p class="application_values">`+ y.icon+ ` `+y.name+`</p>

                        `

                    })
                    $('#managers_div'+b.id).html(pstatus);
        
                   
                  })
            }
        });
    }
      

    function rejectleave(){
         
        var id = '{{manager_approvel_id}}'

        var reason = $("#reason").val();
        if (IsValid(reason)){
            $('#reasonerror').html('');
            $('#reasonerror').show().delay(3000).slideUp();
            $('#reasonerror').html('This field is required');
            $('#reason').focus();
            return false;
        }else if (!/\S/.test(reason)){
          $('#reasonerror').html('');
          $('#reasonerror').show().delay(3000).slideUp();
          $('#reasonerror').html('This field is required');
          $('#reason').focus();
            return false;
        }else{
          $.ajax( {
            url: frontendURL +"leave/leaveactionFront",
            type: 'POST',
            headers: {
              'Authorization':'Token {{token}}'
          },
            data:{
              csrfmiddlewaretoken:'{{ csrf_token }}',
              'id':id,
              'comment':reason,
              },
            dataType: 'json',
            beforeSend: function() {
              swal({
                icon: "info",
                title: "",
                text: "Loading...",
                buttons: false,
      
            });
            },
            success: function(response){
              $("#rejectmodal").modal("toggle");

              console.log("respo",response)
              if (response['response']['n'] == 1){
                swal({
                  icon: "success",
                  title: "",
                  text: "Application rejected Successfully.",
                  button: "Close",
                  }).then(() => {
                    // Code to execute after the user closes the SweetAlert dialog
                    window.location.href = "/leave/request"; // Replace with your desired URL
                });
                    }
              else{

                swal({
                  icon: "error",
                  title: "",
                  text: response['response']['msg'],  
                  button: "Close",
                  }).then(() => {

                    // Code to execute after the user closes the SweetAlert dialog
                    //window.location.href = "/leave/request"; // Replace with your desired URL
                });
              }   
              
            }
          });
        }
    }

    function ApplicationApprove(){
        $("#acceptmodal").modal("toggle");

           
        var id = '{{manager_approvel_id}}'

          $.ajax( {
            url: frontendURL +"leave/leaveactionFront",
            type: 'POST',
            headers: {
              'Authorization':'Token {{token}}'
          },
            data:{
              csrfmiddlewaretoken:'{{ csrf_token }}',
              'id':id,        
              },
            dataType: 'json',
            beforeSend: function() {
              swal({
                icon: "info",
                title: "",
                text: "Loading...",
                buttons: false,
      
            });
            },
            success: function(response){
              console.log("respo app",response)

              if (response['response']['n'] == 1){
                swal({
                      icon: "success",
                      title: "",
                      text: "Application Accepted Successfully",
                      button: "Close",
                      }).then(() => {
                        // Code to execute after the user closes the SweetAlert dialog
                        window.location.href = "/leave/request"; // Replace with your desired URL
                    });
              }
              else{
                swal({
                      icon: "error",
                      title: "",
                      text: response['response']['msg'],
                      button: "Close",
                      }).then(() => {
                        // Code to execute after the user closes the SweetAlert dialog
                        window.location.href = "/leave/request"; // Replace with your desired URL
                    });
              }
    
              
              
            }
          });
        
    }
</script>

{% endblock %}