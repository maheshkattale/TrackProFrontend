{% extends "index.html" %}
{% load static %} 
{% block headercontent %}
  Department Master
{% endblock %}
{% block content %}
<style>
  .fa-minus-circle{
    font-size:22px
  }
  .savebtn {
    background: #00a1ff !important;
    padding: 5px 25px !important;
    margin: 0px !important;
    border-radius: 24px !important;
    font-size: 15px !important;
    color: white !important;
    text-align: center;
    border: none;
}



#addEmployeeForm input {
  width: 100%;
  font-size: 14px;
  color: black; 

}
.modal-body input {
font-size: 14px;
margin-bottom: 10px;
}
.select2-container .select2-selection--single .select2-selection__rendered {
  font-size: 14px;
  color: black;
}


</style>
<main class="main-wrapper">
    {% if messages %}
      <div class="row" style="justify-content: center;">
        <div class="col-sm-6 col-sm-offset-3">
          {% for message in messages %}
          <div style="display: flex; margin: 15px 0px;flex-direction: row-reverse;justify-content: center;align-items: center;" class="alert alert-meaasge alert-{{ message.tags }} alert-dismissible text-center" role="alert">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close" style="background: transparent; border: none; font-size: 25px; color: #ff0000;">
              <span aria-hidden="true">&times;</span>
            </button>
            <p style="margin-bottom: 0px;">{{ message }}</p>
          </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
    <div id="snackbar"></div>
   
 

  <div class="table-div">
    <div class="table-responsive">
      <table class="row-border w-100" id="myTable">
          <thead>
              <th style="width:10%;text-align: center;">
                  Sr.No
              </th>
              <th style="width:20%;">
                  Department Name
              </th>
              <th style="width:20%;">
                 Department Head
              </th>
              <th style="width:40%;">
                Department Members
              </th>
              <th  style="width:10%;text-align: center;">
                  Action
              </th>
          </thead>

          <tbody>
              {% for i in departmentlist %}
                  <tr>
                      <td style="text-align: center;">{{forloop.counter}}.</td>
                      <td>{{i.DepartmentName}}</td>
                      <td>{{i.departmentheadstr}}</td>
                      <td>
                        {% for u in i.deptteamlist %}
                        {{ u }}{% if not forloop.last %}, {% endif %}
                        {%endfor%}
                      </td>
                      <td class="actionflex">
                        <a class="viewEmpDeetsBtn me-2" data-bs-toggle="modal" data-bs-target="#updateexampleModal{{i.id}}"><img class="edit-icon" src="{% static 'assets/images/Group 16728.svg' %}" height="20px" alt="edit icon">
                        </a> 
                        {%if i.Used == True %}
                        <a class="px-1" onclick="return false;"><i class="fa text-danger fa-minus-circle" aria-hidden="true" data-bs-toggle="tooltip" title="used"></i>
                        {%else%}

                        <a class="px-1" data-bs-toggle="modal"  data-bs-target="#deletedepartment{{i.id}}" ><img src="{% static 'assets/images/Group 16729.svg' %}" height="20px" alt="delete icon" data-bs-toggle="tooltip" title="unused"></a>
                        <div class="modal fade" id="deletedepartment{{i.id}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                          <div class="modal-dialog modal-dialog-centered w-25">
                          
                            <div class="modal-content">           
                              <div class="modal-header ps-3 text-center">
                                <h5 class="modal-title py-2" id="exampleModalLabel">Delete Department</h5>
                              </div>
                              <div class="modal-body">
                                
                                <div class="row">
                                  <div> Are you sure you want to delete this?
                  
                                  </div>
                               
                              
                             
                             
                                </div>
                              
                              </div>
                              <div class="modal-footer ">
                                  <button type="button" class="btn btn-gradient-danger btn-rounded btn-fw" data-bs-dismiss="modal">Close</button>
                      
                                  <a href="{% url 'users:delete_department' i.id %}"  class="btn btn-gradient-danger btn-rounded btn-fw" id="addEmployeeBtn">Delete</a>
                  
                              </div>
                            </div>
                          </div>
                        </div>
                        {%endif%}
                      </td>
                  </tr>
              {%endfor%}

          </tbody>
      </table>
  </div>
</div>
  <!-- Update department start-->
    <!-- Button trigger modal -->
    <div class="modal fade" id="AddDepartment"  aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <form  class="formstyle" method="POST">
            {% csrf_token %}
            <div class="modal-content">           
              <div class="modal-header ps-4">
                <h5 class="modal-title py-2" id="exampleModalLabel">Add Department</h5>
              </div>
              <div class="modal-body">
                
                <div class="row">
                  <div class="col-12">
                    <div class="">
                        <label for="DepartmentName">Department Name<span style="color:red;">*</span></label>
                        <input type="text" id="DepartmentName" class="form-control" placeholder="Enter department" name="DepartmentName" oninput="this.value = this.value.replace(/[^a-zA-Z ]+/g,'').replace(/(\..*)\./g, '$1');">
                        <span id="DepartmentNameerror" class="error-message"></span>
                    </div>
                  </div>
                  
                
                  <div class="col-12 ">
                    <div class="">
                      <label for="departmenthead">Department Head<span style="color:red;">*</span></label>

                      <select id='departmenthead' name="departmenthead" class="form-control js-example-basic-single" aria-label="Floating label select example">
                        <option value="">Select Department Head</option>
                        {% for u in employeelist %}
                        <option value="{{u.id}}">{{u.Firstname}} {{u.Lastname}}</option>
                        {% endfor %}
                      </select>
                      <span id="DepartmentHeaderror" class="error-message"></span>
                    </div>
                  </div>
              
              
                </div>
              
              </div>
              <div class="modal-footer mt-3">
                <button type="button" class="btn btn-gradient-danger btn-rounded btn-fw" data-bs-dismiss="modal">Close</button>
                <button onclick="return formValidation();" type="submit" class="btn btn-gradient-info btn-rounded btn-fw" id="">+Add</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    <!--update Modal -->
    {% for i in departmentlist %}
    <div class="modal fade" id="updateexampleModal{{i.id}}"  aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <form action="POST" class="formstyle" method="POST">
            {% csrf_token %}
          <div class="modal-content">           
            <div class="modal-header ps-4">
              <h5 class="modal-title py-2" id="exampleModalLabel">Update Department</h5>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col-12">
                  <div class="">
                      <label for="DepartmentName">Department Name<span style="color:red;">*</span></label>
                      <input type="text"  class="form-control"  id="departmentName{{i.id}}" value="{{i.DepartmentName}}" placeholder="Enter department" name="DepartmentName" oninput="this.value = this.value.replace(/[^a-zA-Z ]+/g,'').replace(/(\..*)\./g, '$1');">
                      <span id="departmentnameerror{{i.id}}" class="error-message"></span>
                  </div>
                </div>
                <div class="col-12">
                  <div class="">
                    <label for="departmenthead">Department Head</label>
                    <select id="DepartmentHead{{i.id}}" name="departmenthead" class="form-control js-example-basic-single">
                    {% for u in employeelist %}
                      {% if i.DepartmentHead == u.id %}
                      <option value="{{u.id}}" selected>{{u.Firstname}} {{u.Lastname}}</option>
                      {% else %}
                      <option value="{{u.id}}">{{u.Firstname}} {{u.Lastname}}</option>
                      {% endif %}
                    {% endfor %}
                    </select>
                    <span id="DepartmentHeaderror{{i.id}}" class="error-message"></span>
                </div>
              </div>
              </div>
            </div>
            <div class="modal-footer mt-3">
              <button type="button" class="btn btn-gradient-danger btn-rounded btn-fw" data-bs-dismiss="modal">Close</button>
              <button type="button" onclick="updateDepartment('{{i.id}}');" class="btn btn-gradient-info btn-rounded btn-fw" id="editEmployeeDetails">Update</button>
            </div>
          </div>
          </form>
        </div>
    </div>
    {%endfor%}


</main>
{% endblock %}
{% block indexaddbuttons %}

<li><a data-bs-toggle="modal" data-bs-target="#AddDepartment">
  <img id="icon" class="floatingimg" data-bs-toggle="tooltip" data-bs-placement="left" title="Add Department"
  src="{% static 'assets/svg/departmentmastericon.svg' %}">
</a></li>
 {% endblock %}
{% block script %}
{{block.super}}
<script>
    $(document).ready(function () {
        $('#myTable').DataTable();

    });
    function formValidation(){

      var DepartmentName = $('#DepartmentName').val().trim();   
      var DepartmentHead = $('#departmenthead').val();   
    
      if (IsValid(DepartmentName)) {
        $('#DepartmentName').html();
        $('#DepartmentNameerror').show().delay(3000).slideUp();
        $('#DepartmentNameerror').html('Department Name is required');
        $('#DepartmentName').focus();
        return false;
      }
      if (IsValid(DepartmentHead)) {
          $('#departmenthead').html();
          $('#DepartmentHeaderror').show().delay(3000).slideUp();
          $('#DepartmentHeaderror').html('Department Head is required');
          $('#departmenthead').focus();
          return false;
      }
    }

    function updateDepartment(id) {
       
      var updatedepartmentname = $('#departmentName'+id).val().trim();
      var DepartmentHead = $('#DepartmentHead'+id).val();   

      if (IsValid(updatedepartmentname)) {
        $('#departmentName'+id).html('');
        $('#departmentnameerror'+id).show().delay(3000).slideUp();
        $('#departmentnameerror'+id).html('Department name is required');
        $('#departmentName'+id).focus();
          return false;
      }
      if (IsValid(DepartmentHead)) {
        $('#DepartmentHead'+id).html();
        $('#DepartmentHeaderror'+id).show().delay(3000).slideUp();
        $('#DepartmentHeaderror'+id).html('Department Head is required');
        $('#DepartmentHead'+id).focus();
        return false;
      }
      else{

      $.ajax({
          type: "POST",
          url: frontendURL + "updatedepartment",
          data: {
              'DepartmentName': updatedepartmentname,
              'departmentId':id,
              'departmenthead':DepartmentHead,
              csrfmiddlewaretoken: '{{ csrf_token }}',
          },
          success: function (response) {         
              console.log("reps",response.data.n)
              if(response.data.n == 1){
                  window.location = frontendURL + "department";
              }else{
                  window.location = frontendURL + "department";
              }
              
          }
      });
      }
    }


</script>
{% endblock %}